<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LawAndGood - ì†Œì†¡ê¸ˆìœµ AI ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .grade-high { background: #fee2e2; color: #991b1b; }
        .grade-medium { background: #fef9c3; color: #854d0e; }
        .grade-low { background: #dcfce7; color: #166534; }
        .grade-error { background: #f3f4f6; color: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

<header class="bg-gray-800 border-b border-gray-700 py-6">
    <div class="max-w-7xl mx-auto px-4">
        <h1 class="text-3xl font-bold">âš–ï¸ LawAndGood</h1>
        <p class="text-gray-400 mt-1">ì†Œì†¡ê¸ˆìœµ AI ë¶„ì„ ëŒ€ì‹œë³´ë“œ</p>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">
    <section class="grid grid-cols-4 gap-4 mb-8">
        <div class="bg-gray-800 rounded-lg p-4 text-center">
            <p class="text-gray-400 text-sm">ì „ì²´ ê¸°ì‚¬</p>
            <p class="text-2xl font-bold" id="total">-</p>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 text-center">
            <p class="text-gray-400 text-sm">ë¶„ì„ ì™„ë£Œ</p>
            <p class="text-2xl font-bold text-green-400" id="analyzed">-</p>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 text-center">
            <p class="text-gray-400 text-sm">íˆ¬ìì í•© High</p>
            <p class="text-2xl font-bold text-red-400" id="highCount">-</p>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 text-center">
            <p class="text-gray-400 text-sm">ë¯¸ë¶„ì„</p>
            <p class="text-2xl font-bold text-yellow-400" id="pending">-</p>
        </div>
    </section>

    <section class="mb-4 flex gap-2">
        <button onclick="filterBy('all')" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600">ì „ì²´</button>
        <button onclick="filterBy('High')" class="px-4 py-2 bg-red-900 rounded hover:bg-red-800">ğŸ”´ High</button>
        <button onclick="filterBy('Medium')" class="px-4 py-2 bg-yellow-900 rounded hover:bg-yellow-800">ğŸŸ¡ Medium</button>
        <button onclick="filterBy('Low')" class="px-4 py-2 bg-green-900 rounded hover:bg-green-800">ğŸŸ¢ Low</button>
    </section>

    <section class="overflow-x-auto">
        <table class="w-full text-sm text-left">
            <thead class="bg-gray-800 text-gray-400 uppercase text-xs">
                <tr>
                    <th class="px-4 py-3">ì œëª©</th>
                    <th class="px-4 py-3">ì†Œì†¡ê°€ëŠ¥ì„±</th>
                    <th class="px-4 py-3">í”¼í•´ê·œëª¨</th>
                    <th class="px-4 py-3">ì§‘ë‹¨ì†Œì†¡</th>
                    <th class="px-4 py-3">íˆ¬ìì í•©ë„</th>
                    <th class="px-4 py-3">ìš”ì•½</th>
                    <th class="px-4 py-3">ë‚ ì§œ</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-gray-700">
                <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </section>
</main>

<script>
const SHEET_ID = '18Po9tadI7g0yMdLrIE8ueC6tYP-SnstUtOTRMCEKwus';
const SHEET_NAME = 'Sheet1';

// Google Sheets ì»¬ëŸ¼ ìˆœì„œ (A~Lì—´) â€” í—¤ë”ê°€ ë¹ˆ ë¬¸ìì—´ë¡œ ì˜¬ ë•Œ ëŒ€ë¹„
const COLUMN_MAP = [
    'title', 'description', 'link', 'pubDate', 'keywords', 'source',
    'ë¶„ì„ìƒíƒœ', 'ì†Œì†¡ê°€ëŠ¥ì„±', 'í”¼í•´ê·œëª¨', 'ì§‘ë‹¨ì†Œì†¡', 'íˆ¬ìì í•©ë„', 'ìš”ì•½'
];

let allData = [];

function loadData() {
    const callbackName = 'gsheetCallback_' + Date.now();

    window[callbackName] = function(response) {
        try {
            // í—¤ë” ì¶”ì¶œ: gviz labelì´ ë¹„ì–´ìˆìœ¼ë©´ COLUMN_MAP ì‚¬ìš©
            const headers = response.table.cols.map((c, i) => {
                return (c.label && c.label.trim()) ? c.label.trim() : (COLUMN_MAP[i] || `col_${i}`);
            });

            console.log('Headers:', headers);

            const rows = response.table.rows.map(row => {
                const obj = {};
                row.c.forEach((cell, i) => {
                    if (i < headers.length) {
                        obj[headers[i]] = cell ? (cell.v !== null && cell.v !== undefined ? String(cell.v) : '') : '';
                    }
                });
                return obj;
            });

            allData = rows;
            console.log('Total rows:', rows.length);
            console.log('Sample row:', JSON.stringify(rows[0]));
            console.log('Analyzed count:', rows.filter(r => r['ë¶„ì„ìƒíƒœ'] === 'done').length);

            updateStats();
            renderTable(rows);
        } catch (e) {
            console.error('íŒŒì‹± ì‹¤íŒ¨:', e);
            document.getElementById('tableBody').innerHTML =
                `<tr><td colspan="7" class="px-4 py-8 text-center text-red-400">ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨: ${e.message}</td></tr>`;
        }
        delete window[callbackName];
        const el = document.getElementById(callbackName);
        if (el) el.remove();
    };

    const script = document.createElement('script');
    script.id = callbackName;
    script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json;responseHandler:${callbackName}&sheet=${SHEET_NAME}&headers=1`;
    script.onerror = function() {
        document.getElementById('tableBody').innerHTML =
            '<tr><td colspan="7" class="px-4 py-8 text-center text-red-400">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨<br>Google Sheets ê³µìœ  ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”</td></tr>';
    };
    document.body.appendChild(script);
}

function updateStats() {
    const total = allData.length;
    const analyzed = allData.filter(r => r['ë¶„ì„ìƒíƒœ'] === 'done').length;
    const high = allData.filter(r => r['íˆ¬ìì í•©ë„'] === 'High').length;
    document.getElementById('total').textContent = total;
    document.getElementById('analyzed').textContent = analyzed;
    document.getElementById('highCount').textContent = high;
    document.getElementById('pending').textContent = total - analyzed;
}

function gradeClass(val) {
    if (val === 'High' || val === 'ëŒ€ê·œëª¨') return 'grade-high';
    if (val === 'Medium' || val === 'ì¤‘ê·œëª¨') return 'grade-medium';
    if (val === 'Low' || val === 'ì†Œê·œëª¨') return 'grade-low';
    return 'grade-error';
}

function badge(val) {
    if (!val) return '<span class="px-2 py-1 rounded text-xs font-bold grade-error">-</span>';
    return `<span class="px-2 py-1 rounded text-xs font-bold ${gradeClass(val)}">${val}</span>`;
}

function renderTable(data) {
    const analyzed = data.filter(r => r['ë¶„ì„ìƒíƒœ'] === 'done');
    const tbody = document.getElementById('tableBody');
    if (analyzed.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">ë¶„ì„ëœ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
    }
    tbody.innerHTML = analyzed.map(r => `
        <tr class="hover:bg-gray-800">
            <td class="px-4 py-3 max-w-xs">
                <a href="${r.link || '#'}" target="_blank" class="text-blue-400 hover:underline">
                    ${(r.title || '').slice(0, 50)}...
                </a>
            </td>
            <td class="px-4 py-3">${badge(r['ì†Œì†¡ê°€ëŠ¥ì„±'])}</td>
            <td class="px-4 py-3">${badge(r['í”¼í•´ê·œëª¨'])}</td>
            <td class="px-4 py-3">${badge(r['ì§‘ë‹¨ì†Œì†¡'])}</td>
            <td class="px-4 py-3">${badge(r['íˆ¬ìì í•©ë„'])}</td>
            <td class="px-4 py-3 text-gray-300 max-w-xs truncate">${r['ìš”ì•½'] || ''}</td>
            <td class="px-4 py-3 text-gray-500 text-xs whitespace-nowrap">${(r.pubDate || '').slice(0, 16)}</td>
        </tr>
    `).join('');
}

function filterBy(grade) {
    if (grade === 'all') {
        renderTable(allData);
    } else {
        renderTable(allData.filter(r => r['íˆ¬ìì í•©ë„'] === grade));
    }
}

loadData();
setInterval(loadData, 300000);
</script>

</body>
</html>
