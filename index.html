<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LawAndGood - ì†Œì†¡ê¸ˆìœµ AI ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .grade-high {
            background: #991b1b;
            color: #fecaca;
            font-weight: 600;
        }
        .grade-medium {
            background: #ca8a04;
            color: #fef9c3;
            font-weight: 600;
        }
        .grade-low {
            background: #16a34a;
            color: #dcfce7;
            font-weight: 600;
        }
        .grade-error {
            background: #4b5563;
            color: #e5e7eb;
            font-weight: 500;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

<header class="bg-gray-800 border-b border-gray-700 py-6">
    <div class="max-w-7xl mx-auto px-4">
        <h1 class="text-3xl font-bold">âš–ï¸ LawAndGood</h1>
        <p class="text-gray-400 mt-1">ì†Œì†¡ê¸ˆìœµ AI ë¶„ì„ ëŒ€ì‹œë³´ë“œ</p>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">
    <section class="grid grid-cols-4 gap-4 mb-8">
        <div class="bg-gray-800 rounded-lg p-4 text-center">
            <p class="text-gray-400 text-sm">ì „ì²´ ê¸°ì‚¬</p>
            <p class="text-2xl font-bold" id="total">-</p>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 text-center">
            <p class="text-gray-400 text-sm">ë¶„ì„ ì™„ë£Œ</p>
            <p class="text-2xl font-bold text-green-400" id="analyzed">-</p>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 text-center">
            <p class="text-gray-400 text-sm">íˆ¬ìì í•© High</p>
            <p class="text-2xl font-bold text-red-400" id="highCount">-</p>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 text-center">
            <p class="text-gray-400 text-sm">ë¯¸ë¶„ì„</p>
            <p class="text-2xl font-bold text-yellow-400" id="pending">-</p>
        </div>
    </section>

    <section class="mb-4 flex justify-between items-center">
        <div class="flex gap-2">
            <button onclick="filterBy('all')" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600">ì „ì²´</button>
            <button onclick="filterBy('High')" class="px-4 py-2 bg-red-900 rounded hover:bg-red-800">ğŸ”´ High</button>
            <button onclick="filterBy('Medium')" class="px-4 py-2 bg-yellow-900 rounded hover:bg-yellow-800">ğŸŸ¡ Medium</button>
            <button onclick="filterBy('Low')" class="px-4 py-2 bg-green-900 rounded hover:bg-green-800">ğŸŸ¢ Low</button>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-gray-400 text-sm">
                <span id="displayCount">0</span>ê°œ í‘œì‹œ ì¤‘
            </span>
            <select id="pageSize" onchange="changePageSize()" class="px-3 py-2 bg-gray-700 rounded text-sm">
                <option value="50">50ê°œì”©</option>
                <option value="100" selected>100ê°œì”©</option>
                <option value="200">200ê°œì”©</option>
                <option value="500">500ê°œì”©</option>
                <option value="all">ì „ì²´ ë³´ê¸°</option>
            </select>
        </div>
    </section>

    <section class="overflow-x-auto">
        <table class="w-full text-sm text-left table-fixed">
            <thead class="bg-gray-800 text-gray-400 uppercase text-xs">
                <tr>
                    <th class="px-3 py-3 w-[20%]">ì œëª©</th>
                    <th class="px-2 py-3 w-[9%]">ì†Œì†¡ê°€ëŠ¥ì„±</th>
                    <th class="px-2 py-3 w-[9%]">í”¼í•´ê·œëª¨</th>
                    <th class="px-2 py-3 w-[9%]">ì§‘ë‹¨ì†Œì†¡</th>
                    <th class="px-2 py-3 w-[9%]">íˆ¬ìì í•©ë„</th>
                    <th class="px-3 py-3 w-[34%]">ìš”ì•½</th>
                    <th class="px-2 py-3 w-[10%]">ë‚ ì§œ</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-gray-700">
                <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </section>

    <section id="pagination" class="mt-6 flex justify-center items-center gap-2" style="display: none;">
        <button onclick="goToPage(1)" class="px-3 py-2 bg-gray-700 rounded hover:bg-gray-600 disabled:opacity-50" id="firstBtn">ì²˜ìŒ</button>
        <button onclick="goToPage(currentPage - 1)" class="px-3 py-2 bg-gray-700 rounded hover:bg-gray-600 disabled:opacity-50" id="prevBtn">ì´ì „</button>
        <span class="text-gray-400 px-4" id="pageInfo">1 / 1</span>
        <button onclick="goToPage(currentPage + 1)" class="px-3 py-2 bg-gray-700 rounded hover:bg-gray-600 disabled:opacity-50" id="nextBtn">ë‹¤ìŒ</button>
        <button onclick="goToPage(totalPages)" class="px-3 py-2 bg-gray-700 rounded hover:bg-gray-600 disabled:opacity-50" id="lastBtn">ë§ˆì§€ë§‰</button>
    </section>
</main>

<script>
const SHEET_ID = '18Po9tadI7g0yMdLrIE8ueC6tYP-SnstUtOTRMCEKwus';
const SHEET_NAME = 'Sheet1';

const COLUMN_MAP = [
    'title', 'description', 'link', 'pubDate', 'keywords', 'source',
    'ë¶„ì„ìƒíƒœ', 'ì†Œì†¡ê°€ëŠ¥ì„±', 'í”¼í•´ê·œëª¨', 'ì§‘ë‹¨ì†Œì†¡', 'íˆ¬ìì í•©ë„', 'ìš”ì•½'
];

let allData = [];
let currentFilter = 'all';
let currentPage = 1;
let pageSize = 100;
let totalPages = 1;

// JSONP ë°©ì‹: CORS ìš°íšŒ (file:// + GitHub Pages ëª¨ë‘ ì‘ë™)
function loadData() {
    const callbackName = 'gsheetCallback_' + Date.now();

    window[callbackName] = function(response) {
        try {
            const headers = response.table.cols.map((c, i) => {
                return (c.label && c.label.trim()) ? c.label.trim() : (COLUMN_MAP[i] || `col_${i}`);
            });

            console.log('Headers:', headers);

            const rows = response.table.rows.map(row => {
                const obj = {};
                row.c.forEach((cell, i) => {
                    if (i < headers.length) {
                        obj[headers[i]] = cell ? (cell.v !== null && cell.v !== undefined ? String(cell.v) : '') : '';
                    }
                });
                return obj;
            });

            allData = rows;
            console.log('Total rows:', rows.length);
            console.log('Analyzed count:', rows.filter(r => r['ë¶„ì„ìƒíƒœ'] === 'done').length);

            updateStats();
            applyFilter();
        } catch (e) {
            console.error('íŒŒì‹± ì‹¤íŒ¨:', e);
            document.getElementById('tableBody').innerHTML =
                `<tr><td colspan="7" class="px-4 py-8 text-center text-red-400">ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨: ${e.message}</td></tr>`;
        }
        delete window[callbackName];
        const el = document.getElementById(callbackName);
        if (el) el.remove();
    };

    const script = document.createElement('script');
    script.id = callbackName;
    script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json;responseHandler:${callbackName}&sheet=${SHEET_NAME}&headers=1`;
    script.onerror = function() {
        document.getElementById('tableBody').innerHTML =
            '<tr><td colspan="7" class="px-4 py-8 text-center text-red-400">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨<br>Google Sheets ê³µìœ  ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”</td></tr>';
    };
    document.body.appendChild(script);
}

function updateStats() {
    const total = allData.length;
    const analyzed = allData.filter(r => r['ë¶„ì„ìƒíƒœ'] === 'done').length;
    const high = allData.filter(r => r['íˆ¬ìì í•©ë„'] === 'High').length;
    document.getElementById('total').textContent = total;
    document.getElementById('analyzed').textContent = analyzed;
    document.getElementById('highCount').textContent = high;
    document.getElementById('pending').textContent = total - analyzed;
}

function gradeClass(val) {
    if (val === 'High' || val === 'ëŒ€ê·œëª¨') return 'grade-high';
    if (val === 'Medium' || val === 'ì¤‘ê·œëª¨') return 'grade-medium';
    if (val === 'Low' || val === 'ì†Œê·œëª¨') return 'grade-low';
    return 'grade-error';
}

function badge(val) {
    if (!val) return '<span class="px-2 py-1 rounded text-xs font-bold grade-error">-</span>';
    return `<span class="px-2 py-1 rounded text-xs font-bold ${gradeClass(val)}">${val}</span>`;
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return dateStr.slice(0, 16);
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${year}ë…„ ${month}ì›” ${day}ì¼`;
}

function renderTable(data) {
    const analyzed = data.filter(r => r['ë¶„ì„ìƒíƒœ'] === 'done');
    const tbody = document.getElementById('tableBody');

    if (analyzed.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">ë¶„ì„ëœ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        document.getElementById('pagination').style.display = 'none';
        document.getElementById('displayCount').textContent = '0';
        return;
    }

    const size = pageSize === 'all' ? analyzed.length : parseInt(pageSize);
    totalPages = Math.ceil(analyzed.length / size);
    if (currentPage > totalPages) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;

    const startIdx = (currentPage - 1) * size;
    const endIdx = pageSize === 'all' ? analyzed.length : startIdx + size;
    const pageData = analyzed.slice(startIdx, endIdx);

    tbody.innerHTML = pageData.map(r => `
        <tr class="hover:bg-gray-800">
            <td class="px-3 py-3">
                <a href="${r.link || '#'}" target="_blank" class="text-blue-400 hover:underline line-clamp-2">
                    ${r.title || ''}
                </a>
            </td>
            <td class="px-2 py-3 text-center">${badge(r['ì†Œì†¡ê°€ëŠ¥ì„±'])}</td>
            <td class="px-2 py-3 text-center">${badge(r['í”¼í•´ê·œëª¨'])}</td>
            <td class="px-2 py-3 text-center">${badge(r['ì§‘ë‹¨ì†Œì†¡'])}</td>
            <td class="px-2 py-3 text-center">${badge(r['íˆ¬ìì í•©ë„'])}</td>
            <td class="px-3 py-3 text-gray-300">
                <div class="whitespace-normal break-words leading-relaxed">${r['ìš”ì•½'] || ''}</div>
            </td>
            <td class="px-2 py-3 text-gray-500 text-xs">${formatDate(r.pubDate)}</td>
        </tr>
    `).join('');

    document.getElementById('displayCount').textContent = analyzed.length;

    if (pageSize === 'all') {
        document.getElementById('pagination').style.display = 'none';
    } else {
        document.getElementById('pagination').style.display = 'flex';
        document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
        document.getElementById('firstBtn').disabled = currentPage === 1;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages;
        document.getElementById('lastBtn').disabled = currentPage === totalPages;
    }
}

function filterBy(grade) {
    currentFilter = grade;
    currentPage = 1;
    applyFilter();
}

function applyFilter() {
    if (currentFilter === 'all') {
        renderTable(allData);
    } else {
        renderTable(allData.filter(r => r['íˆ¬ìì í•©ë„'] === currentFilter));
    }
}

function goToPage(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    applyFilter();
}

function changePageSize() {
    const select = document.getElementById('pageSize');
    pageSize = select.value;
    currentPage = 1;
    applyFilter();
}

loadData();
setInterval(loadData, 300000);
</script>

</body>
</html>
