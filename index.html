<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LawAndGood - ì†Œì†¡ê¸ˆìœµ AI ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .grade-high {
            background: #991b1b;
            color: #fecaca;
            font-weight: 600;
        }
        .grade-medium {
            background: #ca8a04;
            color: #fef9c3;
            font-weight: 600;
        }
        .grade-low {
            background: #16a34a;
            color: #dcfce7;
            font-weight: 600;
        }
        .grade-error {
            background: #4b5563;
            color: #e5e7eb;
            font-weight: 500;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .design-btn { opacity: 0.6; }
        .design-btn.active { opacity: 1; font-weight: bold; }
        
        /* Design 1: Black & White */
        body.design-1 { background: #ffffff; color: #1a1a1a; }
        body.design-1 .header-bg { background: #000000; border-color: #e5e7eb; }
        body.design-1 .header-title { color: #ffffff; }
        body.design-1 .header-subtitle { color: #9ca3af; }
        body.design-1 .design-btn { background: #333; color: #fff; }
        body.design-1 .design-btn.active { background: #fff; color: #000; }
        body.design-1 .stat-card { background: #f8f9fa; border-color: #e5e7eb; }
        body.design-1 .stat-label { color: #6b7280; }
        body.design-1 .filter-btn { background: #e5e7eb; color: #1a1a1a; }
        body.design-1 .filter-btn:hover { background: #d1d5db; }
        body.design-1 .count-text { color: #6b7280; }
        body.design-1 .page-select { background: #f8f9fa; color: #1a1a1a; border-color: #d1d5db; }
        body.design-1 .table-container { background: #fff; border-color: #e5e7eb; }
        body.design-1 .table-header { background: #f8f9fa; color: #374151; border-color: #d1d5db; }
        body.design-1 .table-body { color: #1a1a1a; }
        body.design-1 .table-body tr:hover { background: #f9fafb; }
        body.design-1 .table-body a { color: #2563eb; }
        body.design-1 .pagination-btn { background: #e5e7eb; color: #1a1a1a; }
        body.design-1 .pagination-btn:hover { background: #d1d5db; }
        body.design-1 .pagination-info { color: #6b7280; }
        
        /* Design 2: Blue */
        body.design-2 { background: #eff6ff; color: #1e3a8a; }
        body.design-2 .header-bg { background: #1e40af; border-color: #3b82f6; }
        body.design-2 .header-title { color: #fff; }
        body.design-2 .header-subtitle { color: #93c5fd; }
        body.design-2 .design-btn { background: #3b82f6; color: #fff; }
        body.design-2 .design-btn.active { background: #dbeafe; color: #1e40af; }
        body.design-2 .stat-card { background: #dbeafe; border-color: #93c5fd; }
        body.design-2 .stat-label { color: #1e40af; }
        body.design-2 .filter-btn { background: #bfdbfe; color: #1e40af; }
        body.design-2 .filter-btn:hover { background: #93c5fd; }
        body.design-2 .count-text { color: #1e40af; }
        body.design-2 .page-select { background: #dbeafe; color: #1e40af; border-color: #93c5fd; }
        body.design-2 .table-container { background: #fff; border-color: #93c5fd; }
        body.design-2 .table-header { background: #dbeafe; color: #1e40af; border-color: #93c5fd; }
        body.design-2 .table-body { color: #1e3a8a; }
        body.design-2 .table-body tr:hover { background: #f0f9ff; }
        body.design-2 .table-body a { color: #2563eb; }
        body.design-2 .pagination-btn { background: #bfdbfe; color: #1e40af; }
        body.design-2 .pagination-btn:hover { background: #93c5fd; }
        body.design-2 .pagination-info { color: #1e40af; }
        
        /* Design 3: Green */
        body.design-3 { background: #f0fdf4; color: #14532d; }
        body.design-3 .header-bg { background: #15803d; border-color: #22c55e; }
        body.design-3 .header-title { color: #fff; }
        body.design-3 .header-subtitle { color: #86efac; }
        body.design-3 .design-btn { background: #22c55e; color: #fff; }
        body.design-3 .design-btn.active { background: #dcfce7; color: #15803d; }
        body.design-3 .stat-card { background: #dcfce7; border-color: #86efac; }
        body.design-3 .stat-label { color: #15803d; }
        body.design-3 .filter-btn { background: #bbf7d0; color: #15803d; }
        body.design-3 .filter-btn:hover { background: #86efac; }
        body.design-3 .count-text { color: #15803d; }
        body.design-3 .page-select { background: #dcfce7; color: #15803d; border-color: #86efac; }
        body.design-3 .table-container { background: #fff; border-color: #86efac; }
        body.design-3 .table-header { background: #dcfce7; color: #15803d; border-color: #86efac; }
        body.design-3 .table-body { color: #14532d; }
        body.design-3 .table-body tr:hover { background: #f7fee7; }
        body.design-3 .table-body a { color: #16a34a; }
        body.design-3 .pagination-btn { background: #bbf7d0; color: #15803d; }
        body.design-3 .pagination-btn:hover { background: #86efac; }
        body.design-3 .pagination-info { color: #15803d; }
        
        /* Design 4: Gray Dark */
        body.design-4 { background: #1f2937; color: #f9fafb; }
        body.design-4 .header-bg { background: #111827; border-color: #374151; }
        body.design-4 .header-title { color: #f9fafb; }
        body.design-4 .header-subtitle { color: #9ca3af; }
        body.design-4 .design-btn { background: #4b5563; color: #f9fafb; }
        body.design-4 .design-btn.active { background: #6b7280; color: #fff; }
        body.design-4 .stat-card { background: #374151; border-color: #4b5563; }
        body.design-4 .stat-label { color: #d1d5db; }
        body.design-4 .filter-btn { background: #4b5563; color: #f9fafb; }
        body.design-4 .filter-btn:hover { background: #6b7280; }
        body.design-4 .count-text { color: #d1d5db; }
        body.design-4 .page-select { background: #374151; color: #f9fafb; border-color: #4b5563; }
        body.design-4 .table-container { background: #111827; border-color: #374151; }
        body.design-4 .table-header { background: #1f2937; color: #d1d5db; border-color: #374151; }
        body.design-4 .table-body { color: #e5e7eb; }
        body.design-4 .table-body tr:hover { background: #374151; }
        body.design-4 .table-body a { color: #60a5fa; }
        body.design-4 .pagination-btn { background: #4b5563; color: #f9fafb; }
        body.design-4 .pagination-btn:hover { background: #6b7280; }
        body.design-4 .pagination-info { color: #d1d5db; }
    </style>
</head>
<body class="design-1 min-h-screen">

<header class="header-bg border-b py-6">
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold header-title">âš–ï¸ LawAndGood</h1>
                <p class="header-subtitle mt-1">ì†Œì†¡ê¸ˆìœµ AI ë¶„ì„ ëŒ€ì‹œë³´ë“œ</p>
            </div>
            <nav class="flex gap-2">
                <button onclick="switchDesign(1)" id="designBtn1" class="design-btn active px-5 py-2 rounded-lg font-semibold transition-all">1</button>
                <button onclick="switchDesign(2)" id="designBtn2" class="design-btn px-5 py-2 rounded-lg font-semibold transition-all">2</button>
                <button onclick="switchDesign(3)" id="designBtn3" class="design-btn px-5 py-2 rounded-lg font-semibold transition-all">3</button>
                <button onclick="switchDesign(4)" id="designBtn4" class="design-btn px-5 py-2 rounded-lg font-semibold transition-all">4</button>
            </nav>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">
    <section class="grid grid-cols-4 gap-4 mb-8">
        <div class="stat-card rounded-lg p-4 text-center border">
            <p class="stat-label text-sm">ì „ì²´ ê¸°ì‚¬</p>
            <p class="text-2xl font-bold" id="total">-</p>
        </div>
        <div class="stat-card rounded-lg p-4 text-center border">
            <p class="stat-label text-sm">ë¶„ì„ ì™„ë£Œ</p>
            <p class="text-2xl font-bold text-green-600" id="analyzed">-</p>
        </div>
        <div class="stat-card rounded-lg p-4 text-center border">
            <p class="stat-label text-sm">íˆ¬ìì í•© High</p>
            <p class="text-2xl font-bold text-red-600" id="highCount">-</p>
        </div>
        <div class="stat-card rounded-lg p-4 text-center border">
            <p class="stat-label text-sm">ë¯¸ë¶„ì„</p>
            <p class="text-2xl font-bold text-yellow-600" id="pending">-</p>
        </div>
    </section>

    <section class="mb-4 flex justify-between items-center">
        <div class="flex gap-2 flex-wrap">
            <button onclick="filterBy('all')" class="filter-btn px-4 py-2 rounded font-semibold">ì „ì²´</button>
            <button onclick="filterBy('High')" class="filter-btn px-4 py-2 rounded font-semibold">ğŸ”´ High</button>
            <button onclick="filterBy('Medium')" class="filter-btn px-4 py-2 rounded font-semibold">ğŸŸ¡ Medium</button>
            <button onclick="filterBy('Low')" class="filter-btn px-4 py-2 rounded font-semibold">ğŸŸ¢ Low</button>
            <button onclick="filterBy('bookmarked')" class="filter-btn px-4 py-2 rounded font-semibold">â­ ì°œ</button>
            <button onclick="toggleGrouping()" class="filter-btn px-4 py-2 rounded font-semibold">ğŸ”— ê·¸ë£¹í™”</button>
        </div>
        <div class="flex items-center gap-4">
            <span class="count-text text-sm font-medium">
                <span id="displayCount">0</span>ê°œ í‘œì‹œ ì¤‘
            </span>
            <select id="pageSize" onchange="changePageSize()" class="page-select px-3 py-2 border rounded text-sm">
                <option value="50">50ê°œì”©</option>
                <option value="100" selected>100ê°œì”©</option>
                <option value="200">200ê°œì”©</option>
                <option value="500">500ê°œì”©</option>
                <option value="all">ì „ì²´ ë³´ê¸°</option>
            </select>
        </div>
    </section>

    <section class="overflow-x-auto table-container rounded-lg border">
        <table class="w-full text-sm text-left table-fixed">
            <thead class="table-header uppercase text-xs border-b-2">
                <tr>
                    <th class="px-3 py-3 w-[25%] font-bold">ì œëª©</th>
                    <th class="px-2 py-3 w-[10%] font-bold">ì†Œì†¡ê°€ëŠ¥ì„±</th>
                    <th class="px-2 py-3 w-[10%] font-bold">í”¼í•´ê·œëª¨</th>
                    <th class="px-2 py-3 w-[10%] font-bold">ì§‘ë‹¨ì†Œì†¡</th>
                    <th class="px-2 py-3 w-[10%] font-bold">íˆ¬ìì í•©ë„</th>
                    <th class="px-3 py-3 w-[35%] font-bold">ìš”ì•½</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="table-body divide-y">
                <tr><td colspan="6" class="px-4 py-8 text-center">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </section>

    <section id="pagination" class="mt-6 flex justify-center items-center gap-2" style="display: none;">
        <button onclick="goToPage(1)" class="pagination-btn px-3 py-2 rounded disabled:opacity-50" id="firstBtn">ì²˜ìŒ</button>
        <button onclick="goToPage(currentPage - 1)" class="pagination-btn px-3 py-2 rounded disabled:opacity-50" id="prevBtn">ì´ì „</button>
        <span class="pagination-info px-4" id="pageInfo">1 / 1</span>
        <button onclick="goToPage(currentPage + 1)" class="pagination-btn px-3 py-2 rounded disabled:opacity-50" id="nextBtn">ë‹¤ìŒ</button>
        <button onclick="goToPage(totalPages)" class="pagination-btn px-3 py-2 rounded disabled:opacity-50" id="lastBtn">ë§ˆì§€ë§‰</button>
    </section>
</main>

<script>
const SHEET_ID = '18Po9tadI7g0yMdLrIE8ueC6tYP-SnstUtOTRMCEKwus';
const SHEET_NAME = 'Sheet1';

const COLUMN_MAP = [
    'title', 'description', 'link', 'pubDate', 'keywords', 'source',
    'ë¶„ì„ìƒíƒœ', 'ì†Œì†¡ê°€ëŠ¥ì„±', 'í”¼í•´ê·œëª¨', 'ì§‘ë‹¨ì†Œì†¡', 'íˆ¬ìì í•©ë„', 'ìš”ì•½'
];

let allData = [];
let currentFilter = 'all';
let currentPage = 1;
let pageSize = 100;
let totalPages = 1;

// JSONP ë°©ì‹: CORS ìš°íšŒ (file:// + GitHub Pages ëª¨ë‘ ì‘ë™)
function loadData() {
    const callbackName = 'gsheetCallback_' + Date.now();

    window[callbackName] = function(response) {
        try {
            const headers = response.table.cols.map((c, i) => {
                return (c.label && c.label.trim()) ? c.label.trim() : (COLUMN_MAP[i] || `col_${i}`);
            });

            console.log('Headers:', headers);

            const rows = response.table.rows.map(row => {
                const obj = {};
                row.c.forEach((cell, i) => {
                    if (i < headers.length) {
                        obj[headers[i]] = cell ? (cell.v !== null && cell.v !== undefined ? String(cell.v) : '') : '';
                    }
                });
                return obj;
            });

            allData = rows;
            console.log('Total rows:', rows.length);
            console.log('Analyzed count:', rows.filter(r => r['ë¶„ì„ìƒíƒœ'] === 'done').length);

            updateStats();
            applyFilter();
        } catch (e) {
            console.error('íŒŒì‹± ì‹¤íŒ¨:', e);
            document.getElementById('tableBody').innerHTML =
                `<tr><td colspan="7" class="px-4 py-8 text-center text-red-400">ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨: ${e.message}</td></tr>`;
        }
        delete window[callbackName];
        const el = document.getElementById(callbackName);
        if (el) el.remove();
    };

    const script = document.createElement('script');
    script.id = callbackName;
    script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json;responseHandler:${callbackName}&sheet=${SHEET_NAME}&headers=1`;
    script.onerror = function() {
        document.getElementById('tableBody').innerHTML =
            '<tr><td colspan="7" class="px-4 py-8 text-center text-red-400">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨<br>Google Sheets ê³µìœ  ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”</td></tr>';
    };
    document.body.appendChild(script);
}

function updateStats() {
    const total = allData.length;
    const analyzed = allData.filter(r => r['ë¶„ì„ìƒíƒœ'] === 'done').length;
    const high = allData.filter(r => r['íˆ¬ìì í•©ë„'] === 'High').length;
    document.getElementById('total').textContent = total;
    document.getElementById('analyzed').textContent = analyzed;
    document.getElementById('highCount').textContent = high;
    document.getElementById('pending').textContent = total - analyzed;
}

function gradeClass(val) {
    if (val === 'High' || val === 'ëŒ€ê·œëª¨') return 'grade-high';
    if (val === 'Medium' || val === 'ì¤‘ê·œëª¨') return 'grade-medium';
    if (val === 'Low' || val === 'ì†Œê·œëª¨') return 'grade-low';
    return 'grade-error';
}

function badge(val) {
    if (!val) return '<span class="px-2 py-1 rounded text-xs font-bold grade-error">-</span>';
    return `<span class="px-2 py-1 rounded text-xs font-bold ${gradeClass(val)}">${val}</span>`;
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return dateStr.slice(0, 16);
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${year}ë…„ ${month}ì›” ${day}ì¼`;
}

function renderTable(data) {
    const analyzed = data.filter(r => r['ë¶„ì„ìƒíƒœ'] === 'done');
    const tbody = document.getElementById('tableBody');

    if (analyzed.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center">ë¶„ì„ëœ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        document.getElementById('pagination').style.display = 'none';
        document.getElementById('displayCount').textContent = '0';
        return;
    }

    const size = pageSize === 'all' ? analyzed.length : parseInt(pageSize);
    totalPages = Math.ceil(analyzed.length / size);
    if (currentPage > totalPages) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;

    const startIdx = (currentPage - 1) * size;
    const endIdx = pageSize === 'all' ? analyzed.length : startIdx + size;
    const pageData = analyzed.slice(startIdx, endIdx);
    
    // Apply grouping if enabled
    let groups = [];
    let articleToGroup = new Map();
    if (showGrouping) {
        groups = groupSimilarArticles(pageData);
        groups.forEach((group, groupIdx) => {
            group.articles.forEach(article => {
                articleToGroup.set(article, groupIdx);
            });
        });
    }

    tbody.innerHTML = pageData.map(r => {
        const bookmarked = isBookmarked(r);
        const articleJson = JSON.stringify(r).replace(/'/g, '&apos;');
        const groupIdx = articleToGroup.get(r);
        const groupColor = groupIdx !== undefined ? groups[groupIdx].color : 'transparent';
        const borderStyle = groupIdx !== undefined ? 'border-l-4' : '';
        
        return `
        <tr class="${borderStyle}" style="border-left-color: ${groupColor}">
            <td class="px-3 py-3">
                <div class="flex items-center gap-2">
                    <button onclick='toggleBookmark(${articleJson}, event)' class="text-xl hover:scale-110 transition-transform" title="${bookmarked ? 'ì°œ í•´ì œ' : 'ì°œí•˜ê¸°'}">
                        ${bookmarked ? 'â­' : 'â˜†'}
                    </button>
                    ${groupIdx !== undefined ? `<span class="text-xs px-2 py-1 rounded font-bold" style="background-color: ${groupColor}; color: #1a1a1a;">ê·¸ë£¹${groupIdx + 1}</span>` : ''}
                    <a href="${r.link || '#'}" target="_blank" class="hover:underline line-clamp-2 flex-1">
                        ${r.title || ''}
                    </a>
                </div>
            </td>
            <td class="px-2 py-3 text-center">${badge(r['ì†Œì†¡ê°€ëŠ¥ì„±'])}</td>
            <td class="px-2 py-3 text-center">${badge(r['í”¼í•´ê·œëª¨'])}</td>
            <td class="px-2 py-3 text-center">${badge(r['ì§‘ë‹¨ì†Œì†¡'])}</td>
            <td class="px-2 py-3 text-center">${badge(r['íˆ¬ìì í•©ë„'])}</td>
            <td class="px-3 py-3">
                <div class="whitespace-normal break-words leading-relaxed">${r['ìš”ì•½'] || ''}</div>
            </td>
        </tr>
        `;
    }).join('');

    document.getElementById('displayCount').textContent = analyzed.length;

    if (pageSize === 'all') {
        document.getElementById('pagination').style.display = 'none';
    } else {
        document.getElementById('pagination').style.display = 'flex';
        document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
        document.getElementById('firstBtn').disabled = currentPage === 1;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages;
        document.getElementById('lastBtn').disabled = currentPage === totalPages;
    }
}

function filterBy(grade) {
    currentFilter = grade;
    currentPage = 1;
    applyFilter();
}

function applyFilter() {
    if (currentFilter === 'all') {
        renderTable(allData);
    } else if (currentFilter === 'bookmarked') {
        renderTable(allData.filter(r => isBookmarked(r)));
    } else {
        renderTable(allData.filter(r => r['íˆ¬ìì í•©ë„'] === currentFilter));
    }
}

function goToPage(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    applyFilter();
}

function changePageSize() {
    const select = document.getElementById('pageSize');
    pageSize = select.value;
    currentPage = 1;
    applyFilter();
}

// Design Switching
function switchDesign(designNum) {
    for (let i = 1; i <= 4; i++) {
        const btn = document.getElementById(`designBtn${i}`);
        if (i === designNum) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    }
    document.body.className = `design-${designNum} min-h-screen`;
}

// Bookmark System
function getBookmarks() {
    try {
        return JSON.parse(localStorage.getItem('lawandgood_bookmarks') || '[]');
    } catch (e) {
        return [];
    }
}

function generateArticleId(article) {
    return btoa(encodeURIComponent((article.title || '') + (article.pubDate || ''))).substring(0, 32);
}

function isBookmarked(article) {
    const id = generateArticleId(article);
    return getBookmarks().some(b => b.id === id);
}

function toggleBookmark(article, event) {
    if (event) event.stopPropagation();
    
    const id = generateArticleId(article);
    let bookmarks = getBookmarks();
    
    if (bookmarks.some(b => b.id === id)) {
        bookmarks = bookmarks.filter(b => b.id !== id);
    } else {
        bookmarks.push({
            id: id,
            title: article.title,
            link: article.link,
            grade: article['íˆ¬ìì í•©ë„'],
            summary: article['ìš”ì•½'],
            timestamp: Date.now()
        });
    }
    
    localStorage.setItem('lawandgood_bookmarks', JSON.stringify(bookmarks));
    applyFilter();
}

// Title Similarity Grouping
let showGrouping = false;

function extractKeywords(title) {
    if (!title) return [];
    const words = title.match(/[ê°€-í£]{2,}/g) || [];
    const stopWords = ['ê¸°ì‚¬', 'ê´€ë ¨', 'ëŒ€í•œ', 'í†µí•´', 'ìœ„í•´', 'ëŒ€í•´', 'ë”°ë¼', 'ì˜í•´', 'ì—ì„œ', 'ì—ê²Œ', 'ìœ¼ë¡œ', 'ì—ë„', 'ë¶€í„°', 'ê¹Œì§€'];
    return words.filter(w => !stopWords.includes(w));
}

function calculateSimilarity(title1, title2) {
    const keywords1 = new Set(extractKeywords(title1));
    const keywords2 = new Set(extractKeywords(title2));
    if (keywords1.size === 0 || keywords2.size === 0) return 0;
    const intersection = new Set([...keywords1].filter(x => keywords2.has(x)));
    const union = new Set([...keywords1, ...keywords2]);
    return intersection.size / union.size;
}

function groupSimilarArticles(articles, threshold = 0.3) {
    const groups = [];
    const assigned = new Set();
    
    articles.forEach((article, idx) => {
        if (assigned.has(idx)) return;
        const group = {
            articles: [article],
            color: `hsl(${(groups.length * 137) % 360}, 70%, 75%)`
        };
        assigned.add(idx);
        
        articles.forEach((other, otherIdx) => {
            if (otherIdx <= idx || assigned.has(otherIdx)) return;
            if (calculateSimilarity(article.title, other.title) >= threshold) {
                group.articles.push(other);
                assigned.add(otherIdx);
            }
        });
        
        if (group.articles.length > 1) groups.push(group);
    });
    
    return groups;
}

function toggleGrouping() {
    showGrouping = !showGrouping;
    const btn = document.querySelector('[onclick="toggleGrouping()"]');
    if (btn) btn.textContent = showGrouping ? 'ğŸ”— ê·¸ë£¹ í•´ì œ' : 'ğŸ”— ê·¸ë£¹í™”';
    applyFilter();
}

loadData();
setInterval(loadData, 300000);
</script>

</body>
</html>
